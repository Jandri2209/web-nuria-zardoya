---
title: "Buscador"
layout: base.njk
permalink: "/buscador/"
noindex: true
---

<h1>Buscar en el sitio</h1>
<input id="searchBox" type="text" placeholder="Escribe para buscar..." />
<ul id="results"></ul>

<script src="/assets/vendor/lunr.min.js"></script>
<script>
  let idx = null, documents = [];

  function getQuery() {
    const p = new URLSearchParams(location.search);
    return (p.get("q") || "").trim();
  }

  async function initSearch() {
    const res = await fetch("/search.json");
    documents = await res.json();

    idx = lunr(function () {
      this.ref("url");
      this.field("title");
      this.field("description");
      documents.forEach(d => this.add(d));
    });

    // Si viene ?q= del header, busca al cargar
    const q = getQuery();
    const input = document.getElementById("searchBox");
    if (q) {
      input.value = q;
      doSearch(q);
    }

    input.addEventListener("input", (e) => {
      const v = e.target.value.trim();
      if (v.length > 1) doSearch(v);
      else document.getElementById("results").innerHTML = "";
    });
  }

  function doSearch(query) {
    const resultsList = document.getElementById("results");

    const terms = query
      .toLowerCase()
      .replace(/[^\p{L}\p{N}\s]/gu, " ")
      .split(/\s+/)
      .filter(Boolean);

    if (!terms.length) { resultsList.innerHTML = ""; return; }

    let results = idx.query(q => {
      terms.forEach(t => {
        q.term(t, { presence: lunr.Query.presence.SHOULD });
        q.term(t, { presence: lunr.Query.presence.SHOULD, wildcard: lunr.Query.wildcard.TRAILING });
      });
    });

    if (!results.length) {
      results = idx.query(q => {
        terms.forEach(t => {
          q.term(t, { presence: lunr.Query.presence.SHOULD, wildcard: lunr.Query.wildcard.TRAILING });
        });
      });
    }

    resultsList.innerHTML = "";
    if (!results.length) {
      resultsList.innerHTML = '<li class="text-gray-500">Sin resultados. Prueba con otras palabras.</li>';
      return;
    }

    results.forEach(r => {
      const m = documents.find(d => d.url === r.ref);
      if (!m) return;
      const metaLeft = [m.category || m.type].filter(Boolean).join(" · ");
      const metaRight = m.date ? m.date : "";
      const meta = [metaLeft, metaRight].filter(Boolean).join(" · ");

      const li = document.createElement("li");
      li.innerHTML = `
        <a href="${m.url}">${m.title}</a>
        ${meta ? ` – <span class="text-sm text-gray-600">${meta}</span>` : ""}
        ${m.description ? ` – ${m.description}` : ""}
      `;
      resultsList.appendChild(li);
    });
  }
  document.addEventListener("DOMContentLoaded", initSearch);
</script>
