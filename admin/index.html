<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Panel de edici√≥n | Nuria</title>

    <!-- 1) Netlify Identity -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <!-- 2) Contenedor del CMS (para evitar blanco) -->
    <style>
      html, body { height: 100%; margin: 0; }
      #nc-root { min-height: 100vh; }
      #diag { position: fixed; left: 8px; bottom: 8px; background: #111; color: #0f0; padding: 8px 10px; font: 12px/1.4 monospace; border-radius: 6px; max-width: 90vw; z-index: 99999; }
      #diag b { color: #9cf; }
      #diag .err { color: #f66; }
    </style>
  </head>
  <body>
    <noscript>Necesitas activar JavaScript para usar este panel.</noscript>
    <div id="nc-root"></div>
    <div id="diag">‚è≥ Cargando‚Ä¶</div>

    <script>
      // Diagn√≥stico simple en pantalla
      const diag = (msg, cls) => {
        const box = document.getElementById('diag');
        box.innerHTML = (box.innerHTML ? box.innerHTML + '<br>' : '') + (cls ? `<span class="${cls}">${msg}</span>` : msg);
        console.log("[CMS]", msg);
      };
      window.onerror = function (msg, src, line, col, err) {
        diag(`‚ùå Error global: ${msg} @ ${src}:${line}:${col}`, 'err');
      };
    </script>

    <!-- 3) Decap CMS (primero intentamos 3.x) -->
    <script id="decap-main" src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js" onload="diag('‚úÖ decap-cms 3.x cargado');" onerror="diag('‚ùå No carg√≥ decap-cms 3.x', 'err');"></script>

    <script>
      // 4) Fallback autom√°tico a 2.x si CMS no aparece
      function ensureDecapLoaded(next) {
        setTimeout(function(){
          if (window.CMS) { diag('‚úÖ window.CMS existe'); next(); return; }
          diag('‚ö†Ô∏è window.CMS no existe a√∫n. Probando fallback 2.x‚Ä¶');
          const s = document.createElement('script');
          s.src = 'https://unpkg.com/decap-cms@2.10.192/dist/decap-cms.js';
          s.onload = function(){ diag('‚úÖ Carg√≥ fallback 2.x'); next(); };
          s.onerror = function(){ diag('‚ùå Fall√≥ fallback 2.x', 'err'); };
          document.body.appendChild(s);
        }, 400);
      }

      // 5) Inicializaci√≥n manual con logs detallados
      window.CMS_DEBUG = true;
      window.CMS_MANUAL_INIT = true;

      function initCMS() {
        try {
          if (!window.CMS) { diag('‚ùå CMS sigue sin estar disponible', 'err'); return; }
          diag('<b>Inicializando CMS‚Ä¶</b>');
          CMS.init({ config: '/admin/config.yml' });
          // Al cargar config con √©xito, Decap monta UI en #nc-root
        } catch (e) {
          diag('‚ùå Excepci√≥n en CMS.init(): ' + (e && e.message ? e.message : e), 'err');
          console.error(e);
        }
      }

      // 6) Integraci√≥n con Netlify Identity (reload tras login)
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on('init', (user) => {
          diag('‚ÑπÔ∏è Identity init: ' + (user ? 'logueado' : 'no logueado'));
          if (!user) {
            window.netlifyIdentity.on('login', () => { diag('üîÅ Login ‚Üí reload'); location.reload(); });
          }
        });
      } else {
        diag('‚ö†Ô∏è netlifyIdentity no disponible (a√∫n)');
      }

      // 7) Secuencia de arranque
      document.addEventListener('DOMContentLoaded', function(){
        diag('<b>DOM listo</b>');
        ensureDecapLoaded(initCMS);
      });
    </script>
  </body>
</html>
