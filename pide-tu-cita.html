---
layout: base.njk
title: "Pide tu Cita - Nuria Zardoya"
description: "Reserva tu cita online con Nuria Zardoya. Elige el día y la hora que mejor te convenga."
permalink: "/pide-tu-cita/"
---
<div class="container mx-auto px-6">
  <div class="mb-12">
    <h1 class="text-4xl font-bold text-center mb-4">Pide tu cita</h1>
    <p class="text-lg text-gray-600 text-center max-w-3xl mx-auto mb-8">
      Haz clic para cargar el calendario y elegir la hora que mejor te convenga.
    </p>

    <div class="text-center">
      <button id="btn-cita"
              type="button"
              class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-full shadow">
        Abrir calendario
      </button>
    </div>

    <div id="calendly-inline"
         class="mt-8 mx-auto rounded-lg shadow-2xl overflow-hidden"
         style="min-width:320px; height:700px; max-width: 960px;"></div>

    <!-- Fallback: se muestra si no hay consentimiento o si el script falla -->
    <p id="calendly-fallback"
       class="hidden mt-4 text-center text-sm text-gray-600"
       aria-live="polite">
      No se pudo cargar el calendario o no has aceptado las cookies de Marketing.
      Puedes reservar desde
      <a class="underline text-green-700"
         href="https://calendly.com/nuriazardoyalasheras/60min?locale=es"
         target="_blank" rel="noopener">Calendly en una pestaña nueva</a>.
    </p>
  </div>
</div>

<script>
  /* ===== Helpers UI ===== */
  function setBtnLoading(on) {
    const btn = document.getElementById("btn-cita");
    if (!btn) return;
    btn.disabled = on;
    btn.setAttribute("aria-busy", on ? "true" : "false");
    btn.classList.toggle("opacity-60", on);
    btn.classList.toggle("cursor-wait", on);
  }

  function showFallback(msg) {
    setBtnLoading(false);
    const f = document.getElementById("calendly-fallback");
    if (!f) return;
    if (msg) {
      const note = document.createElement("span");
      note.className = "block mb-2";
      note.textContent = msg;
      f.prepend(note);
    }
    f.classList.remove("hidden");
  }

  /* ===== Consentimiento ===== */
  function hasMarketingConsent() {
    try {
      if (window.cookiePrefs && typeof window.cookiePrefs.marketing !== "undefined") {
        return !!window.cookiePrefs.marketing;
      }
      const ls = localStorage.getItem("cookie-consent");
      if (ls) {
        const prefs = JSON.parse(ls);
        if (typeof prefs.marketing !== "undefined") return !!prefs.marketing;
      }
      if (window.consent && typeof window.consent.marketing !== "undefined") {
        return !!window.consent.marketing;
      }
    } catch (e) {}
    return false;
  }

  /* ===== Calendly ===== */
  function isCalendlyMounted() {
    return !!document.querySelector("#calendly-inline iframe");
  }

  function teardownCalendly() {
    // Quita el iframe
    const container = document.getElementById("calendly-inline");
    if (container) container.innerHTML = "";
    // Quita el script
    const s = document.getElementById("calendly-js");
    if (s) s.remove();
    // Muestra fallback
    showFallback("Has desactivado las cookies de Marketing.");
  }

  function initCalendly() {
    if (!window.Calendly) return showFallback();
    setBtnLoading(false);
    Calendly.initInlineWidget({
      url: "https://calendly.com/nuriazardoyalasheras/60min?locale=es",
      parentElement: document.getElementById("calendly-inline")
    });
  }

  function loadCalendly() {
    if (document.getElementById("calendly-js")) return initCalendly();
    setBtnLoading(true);
    const s = document.createElement("script");
    s.src = "https://assets.calendly.com/assets/external/widget.js";
    s.async = true;
    s.id = "calendly-js";
    s.onload = initCalendly;
    s.onerror = () => showFallback("No se pudo cargar el widget de Calendly.");
    document.head.appendChild(s);
  }

  /* ===== Interacciones ===== */
  document.getElementById("btn-cita").addEventListener("click", () => {
    if (!hasMarketingConsent()) {
      if (typeof window.openCookiePreferences === "function") {
        window.openCookiePreferences("marketing");
      } else {
        showFallback("Para mostrar el calendario embebido de Calendly, activa las cookies de Marketing.");
        alert("Activa las cookies de Marketing en Preferencias de cookies.");
      }
      return;
    }
    loadCalendly();
  });

  // Reacciona a cambios de preferencias: monta/desmonta en caliente
  function onConsentUpdate(e) {
    const allowed = !!e.detail?.marketing;
    if (allowed) {
      if (!isCalendlyMounted()) loadCalendly();
    } else {
      if (isCalendlyMounted()) teardownCalendly();
    }
  }
  window.addEventListener("cookie-preferences:updated", onConsentUpdate);
  window.addEventListener("consent:updated", onConsentUpdate);
</script>

<noscript>
  <p class="mt-4 text-center">
    Para reservar sin JavaScript, abre
    <a href="hhttps://calendly.com/nuriazardoyalasheras/60min?locale=es" target="_blank" rel="noopener">
      Calendly en una pestaña nueva
    </a>.
  </p>
</noscript>
