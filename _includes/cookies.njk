{# Banner y modal de preferencias de cookies (AEPD-friendly) #}

<!-- Banner (primera capa) -->
<div id="cookie-banner" class="fixed inset-x-0 bottom-0 z-50 hidden">
  <div class="mx-auto max-w-4xl m-4 rounded-2xl border bg-white shadow-xl p-4 md:p-5">
    <div class="md:flex md:items-start md:gap-4">
      <div class="flex-1">
        <h2 class="text-lg font-semibold mb-1">Tu privacidad nos importa</h2>
        <p class="text-sm text-gray-600">
          Usamos cookies necesarias para que el sitio funcione y, opcionalmente, cookies de analítica y marketing para mejorar la
          experiencia. Puedes aceptar, rechazar o configurar tus preferencias. Consulta la
          <a href="/cookies/" class="underline text-green-700">Política de Cookies</a>.
        </p>
      </div>
      <div class="mt-3 md:mt-0 flex-shrink-0 flex gap-2">
        <button type="button" id="cookie-reject-all" class="px-4 py-2 rounded-xl border text-gray-700">Rechazar</button>
        <button type="button" id="cookie-open-prefs" class="px-4 py-2 rounded-xl border text-gray-700">Preferencias</button>
        <button type="button" id="cookie-accept-all" class="px-4 py-2 rounded-xl bg-green-700 text-white">Aceptar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de preferencias (segunda capa) -->
<div id="cookie-modal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/40" aria-hidden="true"></div>
  <div role="dialog" aria-modal="true" aria-labelledby="cookie-modal-title"
       class="mx-auto max-w-xl mt-24 rounded-2xl border bg-white shadow-2xl p-6 relative
              max-h-[80vh] overflow-y-auto">
    <h3 id="cookie-modal-title" class="text-xl font-semibold mb-2">Preferencias de cookies</h3>
    <p class="text-sm text-gray-600 mb-4">Puedes activar o desactivar categorías no esenciales.</p>

    <div class="space-y-4">
      <div class="flex items-start justify-between gap-4 p-3 rounded-lg border">
        <div>
          <p class="font-medium">Necesarias</p>
          <p class="text-sm text-gray-600">Imprescindibles para el funcionamiento básico (no pueden desactivarse).</p>
        </div>
        <input type="checkbox" checked disabled aria-label="Cookies necesarias">
      </div>

      <div class="flex items-start justify-between gap-4 p-3 rounded-lg border">
        <div>
          <p class="font-medium">Analítica</p>
          <p class="text-sm text-gray-600">Medición anónima para mejorar el sitio (sin identificarte).</p>
        </div>
        <input id="ck-analytics" type="checkbox" aria-label="Cookies de analítica">
      </div>

      <div class="flex items-start justify-between gap-4 p-3 rounded-lg border">
        <div>
          <p class="font-medium">Marketing</p>
          <p class="text-sm text-gray-600">Servicios de terceros (por ejemplo, calendarios embebidos, Ads, etc.).</p>
        </div>
        <input id="ck-marketing" type="checkbox" aria-label="Cookies de marketing">
      </div>
    </div>

    <div class="mt-6 flex justify-end gap-2">
      <button type="button" id="cookie-cancel" class="px-4 py-2 rounded-xl border text-gray-700">Cancelar</button>
      <button type="button" id="cookie-save" class="px-4 py-2 rounded-xl bg-green-700 text-white">Guardar preferencias</button>
    </div>

    <!-- Botón de cierre -->
    <button type="button" class="absolute top-2 right-2 p-2 rounded hover:bg-gray-100" id="cookie-close-x" aria-label="Cerrar">✕</button>
  </div>
</div>

<script>
(() => {
  const LS_KEY = "cookie-consent";
  const IS_TRANSLATE = /\.translate\.goog$/.test(location.hostname);

  const $ = (sel) => document.querySelector(sel);
  const banner = $("#cookie-banner");
  const modal  = $("#cookie-modal");
  const ckAnalytics = $("#ck-analytics");
  const ckMarketing = $("#ck-marketing");

  const btnAcceptAll = $("#cookie-accept-all");
  const btnRejectAll = $("#cookie-reject-all");
  const btnOpenPrefs = $("#cookie-open-prefs");
  const btnSave      = $("#cookie-save");
  const btnCancel    = $("#cookie-cancel");
  const btnCloseX    = $("#cookie-close-x");

  /* === Helpers cookies/localStorage === */
  function writeCookie(name, value, maxAgeSecs = 31536000) {
    try { document.cookie = `${name}=${encodeURIComponent(value)}; Path=/; Max-Age=${maxAgeSecs}; SameSite=Lax`; } catch {}
  }
  function readCookie(name) {
    try {
      const m = document.cookie.match(new RegExp(`(?:^|; )${name}=([^;]*)`));
      return m ? decodeURIComponent(m[1]) : null;
    } catch { return null; }
  }

  function setConsent(consent) {
    const value = { necessary: true, analytics: !!consent.analytics, marketing: !!consent.marketing };
    try { localStorage.setItem(LS_KEY, JSON.stringify(value)); } catch {}
    writeCookie(LS_KEY, JSON.stringify(value));
    window.cookiePrefs = value;
    window.dispatchEvent(new CustomEvent("cookie-preferences:updated", { detail: value }));
    propagateCc(value); // añade _cc a enlaces internos si estamos en translate
  }
  function applyConsent(consent) {
    window.cookiePrefs = { necessary: true, analytics: !!consent.analytics, marketing: !!consent.marketing };
  }

  /* === Param helpers también para HASH (para Google Translate) === */
  function getParamFromHash(name) {
    try {
      const h = (location.hash || "").replace(/^#/, "");
      if (!h) return null;
      const usp = new URLSearchParams(h);
      return usp.get(name);
    } catch { return null; }
  }
  function deleteParamFromHash(name) {
    try {
      const h = (location.hash || "").replace(/^#/, "");
      if (!h) return;
      const usp = new URLSearchParams(h);
      if (!usp.has(name)) return;
      usp.delete(name);
      const newHash = usp.toString();
      history.replaceState({}, "", location.pathname + location.search + (newHash ? "#" + newHash : ""));
    } catch {}
  }
  function cleanupParams() {
    // Borra _cc y _nolang tanto de ? como de #
    const sp = new URLSearchParams(location.search);
    let touched = false;
    ["_cc","_nolang"].forEach(k => { if (sp.has(k)) { sp.delete(k); touched = true; } });
    if (touched) {
      const clean = location.pathname + (sp.toString() ? "?" + sp.toString() : "") + location.hash;
      try { history.replaceState({}, "", clean); } catch {}
    }
    deleteParamFromHash("_cc");
    deleteParamFromHash("_nolang");
  }

  function getConsent() {
    // 1) Query
    const sp = new URLSearchParams(location.search);
    if (sp.has("_cc")) {
      try { const obj = JSON.parse(atob(sp.get("_cc"))); setConsent(obj); return obj; } catch {}
    }
    // 2) Hash
    const ccHash = getParamFromHash("_cc");
    if (ccHash) {
      try { const obj = JSON.parse(atob(ccHash)); setConsent(obj); return obj; } catch {}
    }
    // 3) localStorage
    try { const raw = localStorage.getItem(LS_KEY); if (raw) return JSON.parse(raw); } catch {}
    // 4) cookie
    try { const c = readCookie(LS_KEY); if (c) return JSON.parse(c); } catch {}
    return null;
  }

  function showBanner() { banner?.classList.remove("hidden"); }
  function hideBanner() { banner?.classList.add("hidden"); }
  function openModal()  { modal?.classList.remove("hidden"); document.body.style.overflow = "hidden"; }
  function closeModal() { modal?.classList.add("hidden");    document.body.style.overflow = ""; }

  // === Propagación _cc (solo en translate.goog) ===
  function ccEncode(consent) {
    const v = { necessary: true, analytics: !!consent.analytics, marketing: !!consent.marketing };
    try { return btoa(JSON.stringify(v)); } catch { return ""; }
  }
  function addCcToUrl(u, cc) {
    try {
      const url = new URL(u, location.origin);
      url.searchParams.set("_cc", cc);
      return url.pathname + url.search + url.hash;
    } catch { return u; }
  }
  function propagateCc(consent) {
    if (!IS_TRANSLATE || !consent) return;
    const cc = ccEncode(consent);
    document.querySelectorAll('a[href^="/"]').forEach(a => {
      a.href = addCcToUrl(a.getAttribute("href"), cc);
    });
    document.querySelectorAll('form[action^="/"]').forEach(f => {
      f.action = addCcToUrl(f.getAttribute("action"), cc);
    });
  }

  // API pública
  window.openCookiePreferences = function () {
    const current = getConsent() || { necessary: true, analytics: false, marketing: false };
    if (ckAnalytics) ckAnalytics.checked = !!current.analytics;
    if (ckMarketing) ckMarketing.checked = !!current.marketing;
    openModal();
    (ckAnalytics || ckMarketing || btnSave)?.focus();
  };

  // Banner
  btnAcceptAll?.addEventListener("click", (e) => {
    e.preventDefault();
    setConsent({ analytics: true, marketing: true });
    applyConsent({ analytics: true, marketing: true });
    hideBanner();
    cleanupParams();
  });
  btnRejectAll?.addEventListener("click", (e) => {
    e.preventDefault();
    setConsent({ analytics: false, marketing: false });
    applyConsent({ analytics: false, marketing: false });
    hideBanner();
    cleanupParams();
  });
  btnOpenPrefs?.addEventListener("click", (e) => { e.preventDefault(); window.openCookiePreferences(); });

  // Modal
  btnSave?.addEventListener("click", (e) => {
    e.preventDefault();
    const consent = { analytics: ckAnalytics?.checked || false, marketing: ckMarketing?.checked || false };
    setConsent(consent);
    applyConsent(consent);
    closeModal(); hideBanner();
    cleanupParams();
  });
  btnCancel?.addEventListener("click", (e) => { e.preventDefault(); closeModal(); });
  btnCloseX?.addEventListener("click", (e) => { e.preventDefault(); closeModal(); });

  // Init
  document.addEventListener("DOMContentLoaded", () => {
    // Asegura banner/modal fuera de <form>
    (function __ensureOutsideForms() {
      const b = document.getElementById("cookie-banner");
      const m = document.getElementById("cookie-modal");
      if (b && b.closest("form")) document.body.appendChild(b);
      if (m && m.closest("form")) document.body.appendChild(m);
    })();

    const consent = getConsent();
    if (!consent) showBanner(); else applyConsent(consent);
    propagateCc(consent);
    cleanupParams();
  });

  // Accesibilidad
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && !modal?.classList.contains("hidden")) closeModal();
  });
  modal?.querySelector('[aria-hidden="true"]')?.addEventListener("click", closeModal);

  // Delegado global: footer/header abren preferencias
  document.addEventListener("click", (e) => {
    const t = e.target?.closest?.('#open-cookie-preferences, [data-open-cookie-preferences]');
    if (!t) return;
    e.preventDefault();
    if (typeof window.openCookiePreferences === "function") window.openCookiePreferences();
  });

  // ===== Solo en Google Translate: blindaje anti pop-up reforzado =====
  if (IS_TRANSLATE) {
    document.addEventListener("submit", (e) => {
      const f = e.target;
      if (f && f.closest('#cookie-banner, #cookie-modal')) {
        e.preventDefault(); e.stopPropagation();
      }
    }, true);

    const SEL = '#open-cookie-preferences, [data-open-cookie-preferences], #cookie-accept-all, #cookie-reject-all, #cookie-open-prefs, #cookie-save, #cookie-cancel, #cookie-close-x';
    const intercept = (type) => document.addEventListener(type, (e) => {
      const t = e.target && e.target.closest(SEL);
      if (!t) return;
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
      const id = t.id;
      if (id === 'open-cookie-preferences' || id === 'cookie-open-prefs') {
        window.openCookiePreferences && window.openCookiePreferences();
      } else if (id === 'cookie-accept-all') {
        setConsent({ analytics: true, marketing: true }); applyConsent({ analytics: true, marketing: true }); hideBanner(); cleanupParams();
      } else if (id === 'cookie-reject-all') {
        setConsent({ analytics: false, marketing: false }); applyConsent({ analytics: false, marketing: false }); hideBanner(); cleanupParams();
      } else if (id === 'cookie-save') {
        const consent = { analytics: ckAnalytics?.checked || false, marketing: ckMarketing?.checked || false };
        setConsent(consent); applyConsent(consent); closeModal(); hideBanner(); cleanupParams();
      } else if (id === 'cookie-cancel' || id === 'cookie-close-x') {
        closeModal();
      }
    }, true);

    ['pointerdown','click','touchstart','touchend','mousedown','mouseup','auxclick'].forEach(intercept);
  }

  /* === GA4: sincroniza Consent Mode con el banner === */
  (function(){
    function updateGA(consent){
      if (!window.gtag) return;
      try {
        gtag('consent','update',{
          analytics_storage: consent && consent.analytics ? 'granted' : 'denied',
          ad_storage:       consent && consent.marketing ? 'granted' : 'denied',
          functionality_storage:'granted',
          security_storage:'granted'
        });
      } catch(_) {}
    }

    // Aplica el consentimiento guardado (si existe) al cargar
    try {
      let saved = null;
      const rawLS = localStorage.getItem(LS_KEY);
      if (rawLS) saved = JSON.parse(rawLS);
      if (!saved) {
        const m = document.cookie.match(/(?:^|;\s*)cookie-consent=([^;]+)/);
        if (m) saved = JSON.parse(decodeURIComponent(m[1]));
      }
      if (saved) updateGA(saved);
    } catch(_){}

    // Y en cada cambio emitido por el banner
    window.addEventListener('cookie-preferences:updated', function (ev) {
      updateGA(ev.detail || {});
    });
  })();

})();
</script>
