<header id="site-header" class="bg-white/90 backdrop-blur shadow-md fixed w-full top-0 z-50">
  <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
    <a href="/" class="text-2xl font-bold text-green-600">Nuria Zardoya</a>

    {% set active = "text-green-600 font-semibold" %}
    {% set idle = "text-gray-600 hover:text-green-600" %}

    <!-- Desktop nav + buscador + idiomas -->
    <div class="hidden md:flex items-center space-x-6">
      <!-- Buscador (lupa que expande) -->
      <div class="flex items-center gap-2" id="header-search" data-search>
        <button class="text-gray-600 hover:text-green-600 focus:outline-none"
                aria-label="Abrir bÃºsqueda" aria-expanded="false" aria-controls="search-input">
          <i data-lucide="search" class="w-5 h-5"></i>
        </button>
        <form action="/buscador.html" method="get" class="search-form m-0" role="search">
          <input id="search-input" name="q" type="search" placeholder="Buscarâ€¦"
                 class="w-0 opacity-0 transition-all duration-200
                        px-4 py-2 border border-gray-300 rounded-full
                        focus:outline-none focus:ring-2 focus:ring-green-500
                        bg-white text-sm text-gray-800"
                 autocomplete="off" />
        </form>
      </div>

      {% set isInicio = page.url == '/' %}
      <a href="/"
         class="{% if isInicio %}{{ active }}{% else %}{{ idle }}{% endif %}"
         {% if isInicio %}aria-current="page"{% endif %}>Inicio</a>

      {# QuiÃ©n soy: soporta /quien_soy/ #}
      {% set isQuienSoy = page.url == '/quien_soy/' %}
      <a href="/quien_soy/"
         class="{% if isQuienSoy %}{{ active }}{% else %}{{ idle }}{% endif %}"
         {% if isQuienSoy %}aria-current="page"{% endif %}>QuiÃ©n soy</a>

      {% set isServicios = page.url == '/servicios.html' or page.url == '/servicios/' %}
      <a href="/servicios/"
         class="{% if isServicios %}{{ active }}{% else %}{{ idle }}{% endif %}"
         {% if isServicios %}aria-current="page"{% endif %}>Servicios</a>

      {% set isRecetas = page.url == '/recetas.html' or page.url == '/recetas/' %}
      <a href="/recetas/"
         class="{% if isRecetas %}{{ active }}{% else %}{{ idle }}{% endif %}"
         {% if isRecetas %}aria-current="page"{% endif %}>Recetas</a>

      {% set isContacto = page.url == '/contacto.html' or page.url == '/contacto/' %}
      <a href="/contacto/"
         class="{% if isContacto %}{{ active }}{% else %}{{ idle }}{% endif %}"
         {% if isContacto %}aria-current="page"{% endif %}>Contacto</a>

      {% set isCita = page.url == '/pide_tu_cita.html' or page.url == '/pide-tu-cita/' %}
      <a href="/pide-tu-cita/"
         class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full shadow-lg {% if isCita %}ring-2 ring-green-300{% endif %}">
        Pide tu cita
      </a>

      <!-- Selector de idioma (desktop) -->
      <div class="relative hidden md:block" id="lang-switch-desktop">
        <details class="group">
          <summary class="cursor-pointer flex items-center gap-2 text-gray-600 hover:text-green-600 list-none">
            <i data-lucide="globe" class="w-5 h-5"></i>
            <span class="hidden lg:inline">Idioma</span>
          </summary>

          <ul class="absolute right-0 mt-2 bg-white border border-gray-200 rounded-xl shadow-lg w-48 p-2 space-y-1 z-[60]">
            <li>
              <a id="lang-es" hreflang="es" data-lang="es"
                class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-green-50"
                href="#">
                <span class="emoji-flag" role="img" aria-label="Bandera de EspaÃ±a">ðŸ‡ªðŸ‡¸</span>
                <span>EspaÃ±ol (ES)</span>
              </a>
            </li>
            <li>
              <a id="lang-en" hreflang="en" data-lang="en"
                class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-green-50"
                href="#">
                <span class="emoji-flag" role="img" aria-label="Bandera del Reino Unido">ðŸ‡¬ðŸ‡§</span>
                <span>English (EN)</span>
              </a>
            </li>
            <li>
              <a id="lang-fr" hreflang="fr" data-lang="fr"
                class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-green-50"
                href="#">
                <span class="emoji-flag" role="img" aria-label="Bandera de Francia">ðŸ‡«ðŸ‡·</span>
                <span>FranÃ§ais (FR)</span>
              </a>
            </li>
            <li>
              <a id="lang-eu" hreflang="eu" data-lang="eu"
                class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-green-50"
                href="#">
                <img src="/images/ikurrina.png" alt="IkurriÃ±a (PaÃ­s Vasco)" class="w-5 h-5 rounded-sm">
                <span>Euskara (EU)</span>
              </a>
            </li>
          </ul>
        </details>
      </div>


    <!-- Mobile buttons -->
    <div class="md:hidden flex items-center gap-3">
      <!-- Lupa en mÃ³vil (abre cajÃ³n de bÃºsqueda) -->
      <button id="search-btn-mobile" class="text-gray-600 focus:outline-none" aria-controls="mobile-search" aria-expanded="false">
        <span class="sr-only">Abrir bÃºsqueda</span>
        <i data-lucide="search" class="w-6 h-6"></i>
      </button>

      <button id="menu-btn" class="text-gray-600 focus:outline-none"
              aria-controls="mobile-menu" aria-expanded="false">
        <span class="sr-only">Abrir menÃº</span>
        <i data-lucide="menu" class="w-6 h-6"></i>
      </button>
    </div>
  </nav>

  <!-- CajÃ³n de bÃºsqueda mÃ³vil -->
  <div id="mobile-search" class="hidden md:hidden bg-white border-t border-gray-100 shadow-sm">
    <div class="container mx-auto px-6 py-3">
      <form action="/buscador.html" method="get" role="search" class="flex gap-2">
        <input type="search" name="q" placeholder="Buscarâ€¦"
               class="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-green-500"
               autocomplete="off" />
        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-semibold px-4 py-2 rounded-full">Buscar</button>
      </form>
    </div>
  </div>

  <!-- Mobile menu -->
  <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-gray-100 shadow-sm">
    <nav class="container mx-auto px-6 py-2 space-y-1" role="menu" aria-label="MenÃº mÃ³vil">
      <a href="/" class="block py-2 text-sm hover:bg-green-50" role="menuitem">Inicio</a>
      <a href="/servicios/" class="block py-2 text-sm hover:bg-green-50" role="menuitem">Servicios</a>
      <a href="/recetas/" class="block py-2 text-sm hover:bg-green-50" role="menuitem">Recetas</a>
      <a href="/quien_soy/" class="block py-2 text-sm hover:bg-green-50" role="menuitem">QuiÃ©n soy</a>
      <a href="/contacto/" class="block py-2 text-sm hover:bg-green-50" role="menuitem">Contacto</a>
      <a href="/pide-tu-cita/" class="block py-2 text-sm font-semibold text-green-700 hover:bg-green-50" role="menuitem">
        Pide tu cita
      </a>

      <!-- Selector de idioma (mÃ³vil) -->
      <div class="block md:hidden w-full" id="lang-switch-mobile">
        <div class="border border-gray-200 rounded-xl">
          <button type="button"
                  class="w-full flex items-center justify-between px-4 py-3 text-gray-700"
                  aria-controls="lang-menu-mobile" aria-expanded="false"
                  onclick="
                    const m=document.getElementById('lang-menu-mobile');
                    const exp=this.getAttribute('aria-expanded')==='true';
                    this.setAttribute('aria-expanded', String(!exp));
                    m.classList.toggle('hidden');
                  ">
            <span class="flex items-center gap-2">
              <i data-lucide="globe" class="w-5 h-5"></i>
              <span>Idioma</span>
            </span>
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" d="M6 9l6 6 6-6"/></svg>
          </button>

          <ul id="lang-menu-mobile" class="hidden p-2 space-y-1">
            <li>
              <a id="lang-es-m" hreflang="es" data-lang="es"
                class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-green-50"
                href="#">
                <span class="emoji-flag" role="img" aria-label="Bandera de EspaÃ±a">ðŸ‡ªðŸ‡¸</span>
                <span>EspaÃ±ol (ES)</span>
              </a>
            </li>
            <li>
              <a id="lang-en-m" hreflang="en" data-lang="en"
                class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-green-50"
                href="#">
                <span class="emoji-flag" role="img" aria-label="Bandera del Reino Unido">ðŸ‡¬ðŸ‡§</span>
                <span>English (EN)</span>
              </a>
            </li>
            <li>
              <a id="lang-fr-m" hreflang="fr" data-lang="fr"
                class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-green-50"
                href="#">
                <span class="emoji-flag" role="img" aria-label="Bandera de Francia">ðŸ‡«ðŸ‡·</span>
                <span>FranÃ§ais (FR)</span>
              </a>
            </li>
            <li>
              <a id="lang-eu-m" hreflang="eu" data-lang="eu"
                class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-green-50"
                href="#">
                <img src="/images/ikurrina.png" alt="IkurriÃ±a (PaÃ­s Vasco)" class="w-5 h-5 rounded-sm">
                <span>Euskara (EU)</span>
              </a>
            </li>
          </ul>
        </div>
      </div>

      </div>
      </div>
    </nav>
  </div>
</header>

<script>
  // ===== MenÃº mÃ³vil =====
  (function () {
    const btn = document.getElementById('menu-btn');
    const menu = document.getElementById('mobile-menu');
    if (!btn || !menu) return;

    function closeMenu() { btn.setAttribute('aria-expanded', 'false'); menu.classList.add('hidden'); }
    function openMenu() { btn.setAttribute('aria-expanded', 'true');  menu.classList.remove('hidden'); }

    btn.addEventListener('click', () => {
      const expanded = btn.getAttribute('aria-expanded') === 'true';
      expanded ? closeMenu() : openMenu();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') { closeMenu(); btn.focus(); }
    });

    menu.addEventListener('click', (e) => {
      const target = e.target.closest('a'); if (target) closeMenu();
    });
  })();

  // ===== Buscador desktop: toggle con lupa =====
  (function () {
    const wrap = document.querySelector('#header-search');
    if (!wrap) return;
    const btn = wrap.querySelector('button[aria-controls="search-input"]');
    const input = wrap.querySelector('#search-input');
    const form = wrap.querySelector('form');

    function open() {
      btn.setAttribute('aria-expanded', 'true');
      input.classList.remove('w-0','opacity-0');
      input.classList.add('w-56','opacity-100');
      setTimeout(() => input.focus(), 80);
    }
    function close() {
      btn.setAttribute('aria-expanded', 'false');
      input.classList.add('w-0','opacity-0');
      input.classList.remove('w-56','opacity-100');
    }

    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const expanded = btn.getAttribute('aria-expanded') === 'true';
      expanded ? close() : open();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') close();
    });

    form.addEventListener('submit', (e) => {
      if (!input.value.trim()) e.preventDefault();
    });
  })();

  // ===== Buscador mÃ³vil: cajÃ³n =====
  (function () {
    const btn = document.getElementById('search-btn-mobile');
    const panel = document.getElementById('mobile-search');
    if (!btn || !panel) return;

    function open() { btn.setAttribute('aria-expanded', 'true'); panel.classList.remove('hidden'); setTimeout(() => panel.querySelector('input')?.focus(), 50); }
    function close() { btn.setAttribute('aria-expanded', 'false'); panel.classList.add('hidden'); }

    btn.addEventListener('click', (e) => { e.preventDefault(); const ex = btn.getAttribute('aria-expanded') === 'true'; ex ? close() : open(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });
  })();

  // ===== Enlaces de auto-traducciÃ³n robustos (ES/EN/FR/EU) + _cc =====
  (function () {
    function getCanonical() {
      var link = document.querySelector('link[rel="canonical"]');
      return link && link.href ? link.href : null;
    }
    function getOriginalUrl() {
      var loc = window.location;
      var hrefNoHash = loc.href.split('#')[0];
      var can = getCanonical();
      if (can) return can;
      try {
        var u = new URL(hrefNoHash).searchParams.get('u');
        if (u) return u;
      } catch (_) {}
      if ((loc.hostname || '').endsWith('.translate.goog')) {
        var rawHost = loc.hostname.replace('.translate.goog', '');
        return 'https://' + rawHost + loc.pathname + loc.search;
      }
      return hrefNoHash;
    }

    var original = getOriginalUrl();

    // Lee tu consentimiento actual y lo compacta para pasarlo a Translate
    var cc = '';
    try {
      var ls = localStorage.getItem('cookie-consent');
      if (ls) cc = '&_cc=' + encodeURIComponent(btoa(ls));
    } catch (e) {}

    function withNoLang(url) {
      var sep = url.indexOf('?') > -1 ? '&' : '?';
      return url + sep + '_nolang=1' + cc; // arrastra _cc si existe
    }

    var base = 'https://translate.google.com/translate?sl=es&u=' + encodeURIComponent(original);
    var map = {
      // Desktop
      "lang-es":  withNoLang(original),
      "lang-en":  base + '&tl=en&hl=en' + cc,
      "lang-fr":  base + '&tl=fr&hl=fr' + cc,
      "lang-eu":  base + '&tl=eu&hl=eu' + cc,
      // MÃ³vil
      "mlang-es": withNoLang(original),
      "mlang-en": base + '&tl=en&hl=en' + cc,
      "mlang-fr": base + '&tl=fr&hl=fr' + cc,
      "mlang-eu": base + '&tl=eu&hl=eu' + cc
    };

    Object.keys(map).forEach(function (id) {
      var a = document.getElementById(id);
      if (a) a.setAttribute('href', map[id]);
    });

    // Preferencia ES (igual que antes)
    function setPrefCookie() {
      try { document.cookie = 'langpref=es; Path=/; Max-Age=2592000; SameSite=Lax'; } catch (e) {}
    }
    ['lang-es','mlang-es'].forEach(function (id) {
      var a = document.getElementById(id);
      if (a) a.addEventListener('click', setPrefCookie);
    });
  })();
</script>

<script>
// Hover/focus abre el desplegable de idioma (desktop)
(function () {
  const wrap = document.getElementById('lang-switch-desktop');
  if (!wrap) return;
  const det = wrap.querySelector('details');
  if (!det) return;

  let hoverOpen = false;

  function open() { if (!det.hasAttribute('open')) det.setAttribute('open',''); }
  function close() { if (det.hasAttribute('open') && !hoverOpen) det.removeAttribute('open'); }

  wrap.addEventListener('mouseenter', () => { hoverOpen = true; open(); });
  wrap.addEventListener('mouseleave', () => { hoverOpen = false; close(); });
  wrap.addEventListener('focusin', open);
  wrap.addEventListener('focusout', (e) => {
    if (!wrap.contains(e.relatedTarget)) { hoverOpen = false; close(); }
  });

  // Escape cierra
  wrap.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && det.hasAttribute('open')) {
      hoverOpen = false;
      close();
      wrap.querySelector('summary')?.focus();
      e.preventDefault();
    }
  });
})();
</script>
