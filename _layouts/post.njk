---
layout: base.njk
---

<section class="bg-white">
  <div class="container mx-auto px-6 py-10 max-w-4xl">
    <p class="text-sm text-green-700 font-semibold mb-2">
      {{ category or "Blog" }}
    </p>

    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-3">
      {{ title }}
    </h1>

    {% if description %}
      <p class="text-lg text-gray-600 mb-5">{{ description }}</p>
    {% endif %}

    <div class="text-sm text-gray-500 mb-8">
      {{ date | date("es-ES") }}
    </div>

    {% if image %}
      <figure class="mb-8">
        <img
          src="{{ image }}"
          alt="Imagen de {{ title }}"
          class="rounded-xl shadow w-full object-cover"
          style="max-height: 24rem;">
      </figure>
    {% endif %}

    {# GalerÃ­a opcional (lista de imÃ¡genes) #}
    {% if gallery and gallery.length %}
      <div class="mb-10 overflow-x-auto flex gap-4 pb-2">
        {% for g in gallery %}
          <img
            src="{{ g.image }}"
            alt="Imagen {{ loop.index }} de {{ title }}"
            class="rounded-xl shadow object-cover"
            style="min-width: 60%; max-height: 22rem;">
        {% endfor %}
      </div>
    {% endif %}

    <article class="prose prose-green post-content max-w-none">
      {{ content | safe }}
    </article>

    {# === Instagram: solo carga si Marketing estÃ¡ aceptado === #}
    {% if instagram_embed or instagram_url %}
      <div id="ig-container"
          class="my-8"
          data-ig-url="{{ (instagram_url or '') | trim }}">

        {# Guardamos el embed en <template> para no ejecutarlo hasta que haya consentimiento #}
        <template id="ig-embed-tpl">
          {% if instagram_embed %}
            {{ instagram_embed | safe }}
          {% endif %}
        </template>

        {# Fallback visible cuando NO hay consentimiento de Marketing #}
        <div id="ig-consent"
            class="rounded-xl border border-gray-200 bg-gray-50 p-5">
          <div class="flex items-start gap-3">
            <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-gradient-to-tr from-purple-400 via-pink-400 to-orange-300 text-white">â˜…</span>
            <div class="flex-1">
              <p class="text-sm text-gray-700">
                Para ver este contenido de Instagram, activa las cookies de <strong>Marketing</strong>.
              </p>

              {# Tarjeta-enlace SIN COOKIES #}
              {% if instagram_url %}
                <a id="ig-fallback-link"
                  href="{{ instagram_url | trim }}" target="_blank" rel="noopener nofollow"
                  class="mt-3 inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white border border-gray-300 text-gray-800 hover:border-green-300 hover:bg-green-50">
                  Ver en Instagram ðŸ“·
                </a>
              {% else %}
                <a id="ig-fallback-link"
                  href="#" target="_blank" rel="noopener nofollow"
                  class="mt-3 inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white border border-gray-300 text-gray-800 hover:border-green-300 hover:bg-green-50 hidden">
                  Ver en Instagram ðŸ“·
                </a>
              {% endif %}

              <div class="mt-3 flex flex-wrap gap-2">
                <button id="ig-open-prefs"
                        class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-green-600 hover:bg-green-700 text-white font-semibold">
                  Configurar cookies
                </button>
                <a href="/cookies/" class="inline-flex items-center px-4 py-2 rounded-full bg-white border border-gray-300 text-gray-700">
                  MÃ¡s info
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <script>
        (function () {
          // === Lee el consentimiento guardado (banner tuyo) ===
          function readSavedConsent(){
            try {
              if (window.cookiePrefs) return window.cookiePrefs; // ya aplicado por tu banner
              const rawLS = localStorage.getItem('cookie-consent');
              if (rawLS) return JSON.parse(rawLS);
              const m = document.cookie.match(/(?:^|;\s*)cookie-consent=([^;]+)/); // <-- regex correcta
              if (m) return JSON.parse(decodeURIComponent(m[1]));
            } catch(_) {}
            return null;
          }
          function hasMarketing(){
            const c = readSavedConsent();
            return !!(c && c.marketing);
          }

          function processIG(){
            try{ if (window.instgrm && window.instgrm.Embeds) window.instgrm.Embeds.process(); }catch(e){}
          }

          // Monta el widget (embed o iframe)
          function mountIG(){
            var box = document.getElementById('ig-container');
            if (!box) return;

            // Oculta el aviso (sin borrarlo) por si luego hay que re-mostrarlo
            var consentBox = document.getElementById('ig-consent');
            if (consentBox) consentBox.style.display = 'none';

            // Evita duplicados si ya hay algo montado
            if (box.querySelector('iframe[src*="instagram.com"]') || box.querySelector('blockquote.instagram-media')) {
              if (!window.instgrm && !document.querySelector('script[src*="instagram.com/embed.js"]')) {
                var s0 = document.createElement('script'); s0.src='https://www.instagram.com/embed.js'; s0.async=true; s0.onload=processIG; document.head.appendChild(s0);
              } else { processIG(); }
              return;
            }

            // 1) Â¿hay embed pegado?
            var tpl = document.getElementById('ig-embed-tpl');
            if (tpl && tpl.content && tpl.content.childNodes.length) {
              box.appendChild(tpl.content.cloneNode(true));
            } else {
              // 2) si no, Â¿hay URL? â†’ iframe oficial /embed (limpiando ? y #)
              var rawUrl = box.getAttribute('data-ig-url') || '';
              if (rawUrl) {
                try {
                  var u = new URL(rawUrl, location.origin);
                  u.search = ''; u.hash = '';
                  var embedSrc = u.href.replace(/\/?$/, '/') + 'embed';
                  var f = document.createElement('iframe');
                  f.src = embedSrc;
                  f.allowTransparency = 'true';
                  f.allow = 'encrypted-media';
                  f.frameBorder = '0';
                  f.style.width = '100%'; f.style.height = '600px';
                  f.className = 'w-full rounded-xl border border-gray-200 shadow';
                  box.appendChild(f);
                } catch(e) {
                  var f2 = document.createElement('iframe');
                  f2.src = String(rawUrl).replace(/\/?$/, '/') + 'embed';
                  f2.allowTransparency = 'true';
                  f2.allow = 'encrypted-media';
                  f2.frameBorder = '0';
                  f2.style.width = '100%'; f2.style.height = '600px';
                  f2.className = 'w-full rounded-xl border border-gray-200 shadow';
                  box.appendChild(f2);
                }
              }
            }

            // Cargar embed.js si hace falta (evita duplicados)
            if (!window.instgrm && !document.querySelector('script[src*="instagram.com/embed.js"]')) {
              var s = document.createElement('script');
              s.src = 'https://www.instagram.com/embed.js';
              s.async = true;
              s.onload = processIG;
              document.head.appendChild(s);
            } else {
              processIG();
            }
          }

          // Desmonta el widget y re-muestra el aviso
          function unmountIG(){
            var box = document.getElementById('ig-container');
            if (!box) return;
            box.querySelectorAll('iframe[src*="instagram.com"], blockquote.instagram-media').forEach(function(el){
              if (el.closest && el.closest('template')) return; // deja el <template>
              el.remove();
            });
            var consentBox = document.getElementById('ig-consent');
            if (consentBox) consentBox.style.display = '';
          }

          // Si solo hay EMBED, saca la URL del data-instgrm-permalink y muestra "Ver en Instagram ðŸ“·"
          function hydrateFallbackLinkFromEmbed(){
            var link = document.getElementById('ig-fallback-link');
            if (!link || !link.classList.contains('hidden')) return; // ya estÃ¡ visible (tenÃ­as URL)
            var tpl = document.getElementById('ig-embed-tpl');
            if (!tpl || !tpl.content) return;
            var bq = tpl.content.querySelector('blockquote.instagram-media');
            var href = bq && (bq.getAttribute('data-instgrm-permalink') || (bq.querySelector('a[href]') && bq.querySelector('a[href]').getAttribute('href')));
            if (href) { link.href = href; link.classList.remove('hidden'); }
          }

          // Abre tu modal de cookies
          function wirePrefsButton(){
            var btn = document.getElementById('ig-open-prefs');
            if (!btn) return;
            btn.addEventListener('click', function(e){
              e.preventDefault();
              if (typeof window.openCookiePreferences === 'function') window.openCookiePreferences();
              else location.href = '/cookies/#preferencias';
            });
          }

          function initIG(){
            wirePrefsButton();
            hydrateFallbackLinkFromEmbed();

            // Si ya hay marketing al entrar, monta YA
            if (hasMarketing()) { mountIG(); return; }

            // PequeÃ±os retardos por si cookiePrefs se aplica tras DOMContentLoaded
            setTimeout(function(){ if (hasMarketing()) mountIG(); }, 0);
            setTimeout(function(){ if (hasMarketing()) mountIG(); }, 150);
            window.addEventListener('load', function(){ if (hasMarketing()) mountIG(); });
          }

          if (document.readyState !== 'loading') initIG();
          else document.addEventListener('DOMContentLoaded', initIG);

          // Reaccionar a cambios en tiempo real
          window.addEventListener('cookie-preferences:updated', function (ev) {
            var mk = !!(ev && ev.detail && ev.detail.marketing);
            if (mk) mountIG(); else unmountIG();
          });
        })();
      </script>
    {% endif %}

    {# ====== Prev / Volver / Next (con flechas) ====== #}
    {% set prev = collections.blog | getPreviousCollectionItem(page) %}
    {% set next = collections.blog | getNextCollectionItem(page) %}

    {% if prev %}<link rel="prefetch" href="{{ prev.url }}" as="document">{% endif %}
    {% if next %}<link rel="prefetch" href="{{ next.url }}" as="document">{% endif %}

    {% if prev or next %}
    <nav class="mt-10 border-t border-gray-100 pt-6" aria-label="NavegaciÃ³n del blog">
      <div class="flex items-stretch justify-between gap-3">

        {% if prev %}
        <a id="nav-prev" href="{{ prev.url }}" rel="prev" aria-label="Entrada anterior: {{ prev.data.title }}"
           class="group flex-1 rounded-2xl border border-gray-200 hover:border-green-300 hover:bg-green-50 transition p-4 flex items-center gap-3">
          <span class="inline-flex items-center justify-center w-9 h-9 rounded-full bg-green-100 group-hover:bg-green-200 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
          </span>
          <span class="text-sm">
            <span class="block text-gray-500">Anterior</span>
            <span class="block font-semibold text-gray-900 group-hover:text-green-700 line-clamp-1">{{ prev.data.title }}</span>
          </span>
        </a>
        {% else %}
        <span class="flex-1"></span>
        {% endif %}

        <a id="nav-back" href="/blog/"
           class="shrink-0 inline-flex items-center gap-2 px-5 py-3 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-width="2" d="M8 6h12M8 12h12M8 18h12M3 6h.01M3 12h.01M3 18h.01"/>
          </svg>
          Volver al blog
        </a>

        {% if next %}
        <a id="nav-next" href="{{ next.url }}" rel="next" aria-label="Entrada siguiente: {{ next.data.title }}"
           class="group flex-1 rounded-2xl border border-gray-200 hover:border-green-300 hover:bg-green-50 transition p-4 flex items-center justify-end gap-3">
          <span class="text-sm text-right">
            <span class="block text-gray-500">Siguiente</span>
            <span class="block font-semibold text-gray-900 group-hover:text-green-700 line-clamp-1">{{ next.data.title }}</span>
          </span>
          <span class="inline-flex items-center justify-center w-9 h-9 rounded-full bg-green-100 group-hover:bg-green-200 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </span>
        </a>
        {% else %}
        <span class="flex-1"></span>
        {% endif %}

      </div>
    </nav>
    {% endif %}

    <script>
      document.addEventListener("keydown", (e) => {
        const tag = (e.target && e.target.tagName || "").toLowerCase();
        if (["input","textarea","select"].includes(tag)) return;

        const prev = document.getElementById("nav-prev");
        const next = document.getElementById("nav-next");
        const back = document.getElementById("nav-back");

        if (e.key === "ArrowLeft" && prev) { e.preventDefault(); window.location = prev.href; }
        if (e.key === "ArrowRight" && next) { e.preventDefault(); window.location = next.href; }
        if (e.key === "ArrowUp" && back) { e.preventDefault(); window.location = back.href; }
      });
    </script>
  </div>
</section>

<style>
/* Limita las imÃ¡genes insertadas desde el cuerpo (Markdown) */
.post-content img{
  max-width:100%;
  height:auto;
  display:block;
  margin:1rem auto;
  border-radius:0.75rem;
  box-shadow:0 8px 24px rgba(0,0,0,.06);
}
</style>

{# JSON-LD bÃ¡sico tipo Article (opcional) #}
{% if title %}
<script type="application/ld+json">
{
  "@context":"https://schema.org",
  "@type":"Article",
  "headline": {{ title | dump | safe}},
  {% if description %}"description": {{ description | dump | safe}},{% endif %}
  {% if image %}"image": {{ image | dump | safe}},{% endif %}
  "datePublished": "{{ date or page.date }}",
  {% if instagram_url %}"sameAs": [ {{ instagram_url | dump | safe}} ],{% endif %}
  "mainEntityOfPage": {{ (site.url + page.url) | dump | safe}}
}
</script>
{% endif %}
